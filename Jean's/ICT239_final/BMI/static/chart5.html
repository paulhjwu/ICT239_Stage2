<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<p>Select local CSV File:</p>
<input id="csv" type="file">
    
<output id="out">
    file contents will appear here
</output>

<div>
    <canvas id="myChart" width="650" height="400"></canvas>
</div>

<style>

output {
    display: block;
    margin-top: 4em;
    font-family: monospace;
    font-size: .8em;
    color: rgb(43, 16, 139);
}

</style>

<script>

function getReadings(fileContents) {

    var aArray = fileContents.split('\n');

    var bDate = new Date(3000, 0, 1);
    var lDate = new Date(2000, 11, 31);

    for (let i = 1; i <= aArray.length -1; i++) {

            // console.log(i);
            let row = aArray[i].split(',');
            
            //for (j=0; j < row.length; j++) {
            //console.log(row[j].padEnd(10));
            //}
            
            var parts = row[2].split('-');
            var myDate = new Date(parts[0], parts[1]-1, parts[2]);

            if (myDate <= bDate) {
                bDate = myDate;
            }

            if (myDate >= lDate) {
                lDate = myDate;
            }
            
            if ( readings[row[0]] != null ) {
                readings[row[0]].push([row[2], row[1]]);            
            } else {
                readings[row[0]]=[[row[2], row[1]]];
            }
            
            // console.log(readings[row[0]]); 
        }


    // https://stackoverflow.com/questions/10221445/return-multiple-variables-from-a-javascript-function
    return [readings, bDate, lDate];
}

function dataPrep(redings, bDate, lDate) {

    var chartDim = {};
    var labels = [];

    for (var d = bDate; d <= lDate; d.setDate(d.getDate() + 1)) {

        var month = d.getUTCMonth() + 1; //months from 1-12
        var day = d.getUTCDate() + 1;
        var year = d.getUTCFullYear();

        var aDateString = year + "-" + month + "-" + day;
        labels.push(aDateString);

        for (const [key, value] of Object.entries(readings)) {

            // https://stackoverflow.com/questions/455338/how-do-i-check-if-an-object-has-a-key-in-javascript 
            if (!(key in chartDim)) {
                chartDim[key]=[];
            }
            
            i = 0;

            let filled = false;
            for (const item of value) {

                parts=item[0].split('-');
                let mydate = new Date(parts[0], parts[1] - 1, parts[2]); 
                if (+mydate === +d) {
                    console.log(`${key}:${item[1]}`);
                    chartDim[key].push(Number(item[1]));
                    filled = true;
                } else {
                    if (+mydate > +d) {
                        if (!filled) {
                            chartDim[key].push(null);
                        } 
                        break;
                    }
                }
            }
        }
    }

    return [chartDim, labels];
}


// Javascript parameter passing https://stackoverflow.com/questions/10058814/get-data-from-fs-readfile 

var ctx = document.getElementById('myChart').getContext('2d');

// ctx.canvas.width = 80;
// ctx.canvas.height = 80;

var readings = {} // { "T-group" : [[date, number] ...], ...}

var fileInput = document.getElementById("csv");

readFile = function () {

    var reader = new FileReader();

    var bDate = new Date();
    var lDate = new Date();
    var readings = {};
    var labels = [];

    reader.onload = function () {
        
        // document.getElementById('out').innerHTML = ""; 

        // debugger
        
        let s = reader.result; // csv of Y-label,Date,Value

        // getReadings return the beginning date (bDate) and the last date (lDate)
        // and the readings in turns of [[date0, value0], ....] array

        var data = getReadings(s)

        readings = data[0];
        bDate = data[1];
        lDate = data[2];
        var xLabels = []

        var chartDim = {}

        // dataPrep takes the readings and return
        // the array of x-labels (in terms of YYYY-MM-DD) and 
        // the {y-labels: the array of y-values along the x-labels}

        var data = dataPrep(readings, bDate, lDate)
        chartDim = data[0];
        xLabels = data[1];

        var yLabels = [];
        var yData = [];

        for (const [key, value] of Object.entries(chartDim)) {
            yLabels.push(key);
            yData.push(value);
        }

        debugger
        var myChart = new Chart(ctx, {
            data: {
            labels: xLabels,
            datasets: []
            },
            options: {
                responsive: false
            }
        })

        for (i= 0; i < yLabels.length; i++ ) {
            myChart.data.datasets.push({
            label: yLabels[i],
            type: "line",
            // borderColor: '#'+(0x1ff0000+Math.random()*0xffffff).toString(16).substr(1,6),
            borderColor: '#'+(0x1100000+Math.random()*0xffffff).toString(16).substr(1,6),
            backgroundColor: "rgba(249, 238, 236, 0.74)",
            data: yData[i],
            spanGaps: true
            });
            myChart.update();
        }
    };
        
    // start reading the file. When it is done, calls the onload event defined above.
    reader.readAsBinaryString(fileInput.files[0]);
};

fileInput.addEventListener('change', readFile);

</script>